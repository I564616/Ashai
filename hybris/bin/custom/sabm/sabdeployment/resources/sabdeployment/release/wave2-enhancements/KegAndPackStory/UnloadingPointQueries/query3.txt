import com.sabmiller.core.enums.DeliveryModeType
import org.apache.commons.lang.StringUtils

/**
 * Query that returns list of B2bUnits that has the following:
 * B2bunits with only N/A unloading points!!
 * Created by evariz.p.papellero on 9/6/17.
 */

fss = spring.getBean("flexibleSearchService")

b2bUnits = fss.search("Select {pk} from {B2BUnit} where {accountGroup} ='ZALB'").result
def deliveryModeMapping = [1:DeliveryModeType.CUB_DELIVERY,
                           2:DeliveryModeType.CUSTOMER_DELIVERY,
                           3:DeliveryModeType.CUSTOMER_DELIVERY,
                           5:DeliveryModeType.CUB_DELIVERY,
                           6:DeliveryModeType.CUB_DELIVERY,
                           11:DeliveryModeType.CUB_DELIVERY,
                           13:DeliveryModeType.CUSTOMER_DELIVERY,
                           16:DeliveryModeType.CUSTOMER_DELIVERY]

out.println("B2bunits with only N/A unloading points!!")
out.println("B2BUNIT ID,B2BUNIT NAME,UNLOADING POINTS")


//Loop all b2bUnits
for (b2bUnit in b2bUnits) {
    if (b2bUnit.getUnloadingPoints().size() < 1) {
        continue
    }

    query3 = false; //B2bunits with only N/A unloading points

    iscub = false
    iscustomer = false
    errorMessage = ''<<''
    //Check the unloading points
    for (unloadingPoint in b2bUnit.getUnloadingPoints()) {
        if (StringUtils.isNotEmpty(unloadingPoint.getCode()) && unloadingPoint.getCode().matches("([BULK]|[PACK])+-\\w+-\\d+")) {
            //Derive the Delivery Mode from unloading point code format : PACKTYPE-DAYS-MODE
            codes = unloadingPoint.getCode().split("-")
            unloadingPointmethod = deliveryModeMapping.get(Integer.parseInt(codes[2]))
        } else
        
        {
        query3 = true;
        codes = codes+unloadingPoint.getCode();
        }
        
    }

    if (query3) {
        out.println(b2bUnit.getUid() + "," + b2bUnit.getName() + ","+codes)
    }
}
