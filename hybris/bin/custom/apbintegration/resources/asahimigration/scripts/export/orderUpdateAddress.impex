INSERT_UPDATE ScriptingJob	;code[unique=true]		;scriptURI
							;orderUpdateAddressExportScriptJob	;model://orderUpdateAddressExportScript
							
INSERT_UPDATE CronJob	;code[unique=true]			;job(code)				;sessionLanguage(isocode)	;sessionUser(uid)
						;orderUpdateAddressExportScriptCronJob	;orderUpdateAddressExportScriptJob	;en		;admin

INSERT_UPDATE Script; code[unique=true];content;active[default=true, unique=true]
;orderUpdateAddressExportScript;"
import java.io.File;
import java.io.FileWriter;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

import javax.annotation.Resource;

import org.apache.commons.lang3.StringUtils;
import org.apache.log4j.Logger;

import de.hybris.platform.core.model.order.OrderModel;
import de.hybris.platform.servicelayer.search.FlexibleSearchQuery;
import de.hybris.platform.servicelayer.search.FlexibleSearchService;
import de.hybris.platform.servicelayer.search.SearchResult;
import de.hybris.platform.util.CSVWriter;
import com.google.common.base.Stopwatch;
import de.hybris.platform.catalog.model.CatalogUnawareMediaModel;
import com.google.common.base.Stopwatch;


final Logger LOG = Logger.getLogger(""asahi"");

def exportService = spring.getBean(""exportService"");
SimpleDateFormat format = new SimpleDateFormat(""yyyyMMdd hh:mm:ss"");
Calendar cal1 = Calendar.getInstance();
cal1.set(2021, 7, 20)
cal1.set(Calendar.HOUR_OF_DAY, 0)
cal1.set(Calendar.MINUTE, 0);
cal1.set(Calendar.SECOND, 0);
cal.add(Calendar.MONTH, -18);
Date d = cal1.getTime();
String oldDate = format.format(d);

def creationTime = oldDate;
final Map<String, Object> params = new HashMap<>();
params.put(""creationTime1"", oldDate);

Calendar cal2 = new GregorianCalendar();
cal2.set(2021, 7, 20)
cal2.set(Calendar.HOUR_OF_DAY, 0)
cal2.set(Calendar.MINUTE, 0);
cal2.set(Calendar.SECOND, 0);
Date d1 = cal2.getTime();
String currentDate = new SimpleDateFormat(""yyyy-MM-dd HH:mm:ss.SSS ZZZZ"").format(d1);
params.put(""creationTime2"", currentDate);

final Stopwatch stopwatch = Stopwatch.createUnstarted();
stopwatch.start();

final FlexibleSearchQuery query = new FlexibleSearchQuery(""select {pk} from {Order} where {creationtime}>=?creationTime1 AND {creationtime}<=?creationTime2"", params);
final SearchResult<OrderModel> result = flexibleSearchService
		.search(query);
int count = result.getCount();
println(""Total record count ######"" +count);

int batch  = count > 10000 ? 10000 : count;
int i = 0;
 final File file =new File(""15-orderUpdateAddress-""+new SimpleDateFormat(""yyyyMMddHHmmssSSS"").format(new Date())+"".csv"");
 FileWriter outputfile = new FileWriter(file);
 CSVWriter writer = new CSVWriter(outputfile);	
 char c = ',';
 writer.setFieldseparator(c);
 HashMap<Integer,Object> line = new HashMap();
 
 String header = ""code[unique=true],deliveryAddress(code),paymentAddress(code)"";
 final String[] columns = header.split("",(?=([^\""]*\""[^\""]*\"")*[^\""]*\$)"");
 for (int k =0; k < columns.length ; k++) {
	 line.put (Integer.valueOf(k), columns[k]);
 }
writer.write(line);
		while (i < count)
		{
			query.setStart(i);
			query.setCount(batch);
			final SearchResult<OrderModel> result1 = flexibleSearchService
					.search(query);
	
			List<OrderModel> orders = result1.getResult();		

			for(OrderModel order : orders)
			{
				try {
					line.put(Integer.valueOf(0), order.getCode());
					line.put(Integer.valueOf(1), null != order.getDeliveryAddress() ? order.getDeliveryAddress().getPk().toString() : StringUtils.EMPTY);
					line.put(Integer.valueOf(2), null != order.getPaymentAddress() ? order.getPaymentAddress().getPk().toString() : StringUtils.EMPTY);					
					 writer.write(line);
				}
				 
				  catch(final Exception exception)
				  {
					LOG.error(""Order failed in export : "" + order.getCode() +exception.getStackTrace());
				  }
				}
				i = i+batch;
						
		 }
	writer.close();	
				 
	if (file != null  && file.length() > 0) {
		try {
			
				final InputStream fileInputStream = new FileInputStream(file);
				final CatalogUnawareMediaModel mediaModel = modelService.create(CatalogUnawareMediaModel.class);
				LOG.info(""Media File Name is : ""+file.getName());
				mediaModel.setCode(file.getName() + ""_"" + System.currentTimeMillis());
				mediaModel.setRealfilename(file.getName());
				modelService.save(mediaModel);
				mediaService.setStreamForMedia(mediaModel, fileInputStream);
				modelService.refresh(mediaModel);
			}
		        
        catch (final Exception ex) {
			LOG.error(""Exception while preparing file for  Order ""+ ex);
        }
		finally {
			   LOG.info(""Time taken to export Order : "" + stopwatch.toString());
			   writer.close();
		   }
 }";;

