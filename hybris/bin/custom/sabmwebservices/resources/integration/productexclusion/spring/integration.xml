<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/aop
           http://www.springframework.org/schema/aop/spring-aop.xsd
           http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		   http://www.springframework.org/schema/integration/file http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
		   http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http.xsd
		   http://www.springframework.org/schema/integration/xml
    	   http://www.springframework.org/schema/integration/xml/spring-integration-xml.xsd
    	   http://www.springframework.org/schema/oxm http://www.springframework.org/schema/oxm/spring-oxm.xsd
    	   http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-file="http://www.springframework.org/schema/integration/file"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xmlns:int-xml="http://www.springframework.org/schema/integration/xml"
       xmlns:int-mail="http://www.springframework.org/schema/integration/mail"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:oxm="http://www.springframework.org/schema/oxm">

    <!-- map the incoming webservice request to a channel -->
    <int-http:inbound-gateway id="inboundProductExclusionRequestGateway"
                              supported-methods="POST"
                              path="/services/productexclusion"
                              request-channel="preProductExclusionImportChannel"
                              request-payload-type="java.lang.String"
                              reply-timeout="1800000">
    </int-http:inbound-gateway>

    <!--  Product Exclusion Channels -->
    <int:channel id="productExclusionValidationErrorChannel"/>
    <int:channel id="preProductExclusionImportChannel"/>
    <int:channel id="productExclusionImportChannel"/>
    <int:channel id="postProductExclusionImportChannel"/>

    <!-- map of namespace prefix to URI -->
    <util:map id="productExclusionNamespaceMap">
        <entry key="productExclusionNs" value="urn:gl.sabmiller.com:com:3rdp:mastdata" />
    </util:map>

    <int-xml:xpath-expression id="pexlns" expression="/productExclusionNs:ProductExclusionResponse/MessageHeader/ID" namespace-map="productExclusionNamespaceMap"/>
    <int-xml:xpath-expression id="pexRIdlns" expression="/productExclusionNs:ProductExclusionResponse/MessageHeader/ReferenceID" namespace-map="productExclusionNamespaceMap"/>

    <int:chain id="pre-product-exclusion-import-chain" input-channel="preProductExclusionImportChannel" output-channel="productExclusionImportChannel">
      
        
          <!--  Security filter -->
        <int-xml:validating-filter discard-channel="productExclusionValidationErrorChannel"
                                   throw-exception-on-rejection="true"
                                   xml-validator="securityValidationFilter">
        </int-xml:validating-filter>
    
        <!-- this is require to enrich the header to handle the content-type of type "application/xml" -->
        <int:header-enricher>
            <int:header name="content-type" value="application/xml" />
        </int:header-enricher>

        <!--  Add payload Id to the header -->
        <int-xml:xpath-header-enricher id="prdExlAddPayloadId" default-overwrite="true">
            <int-xml:header name="payloadId"
                            overwrite="true"
                            xpath-expression-ref="pexlns"
                            evaluation-type="STRING_RESULT"/>
        </int-xml:xpath-header-enricher>
		<!--  Add reference Id to the header -->
        <int-xml:xpath-header-enricher id="prdExlAddReferenceId" default-overwrite="true">
            <int-xml:header name="referenceId"
                            overwrite="true"
                            xpath-expression-ref="pexRIdlns"
                            evaluation-type="STRING_RESULT"/>
        </int-xml:xpath-header-enricher>
        <!--  Save the incoming payload in Hybris -->
        <int:service-activator ref="productExclusionImportService" method="savePayload" />
      
        <!--  Validate XML against schema -->
        <int-xml:validating-filter discard-channel="productExclusionValidationErrorChannel"
                                   id="productExclusionValidationFilter"
                                   schema-location="integration/productexclusion/schema/ProductExclusion.xsd"
                                   schema-type="xml-schema" throw-exception-on-rejection="true" >
        </int-xml:validating-filter>

    </int:chain>

    <int:chain id="prd-exl-validation-error-chain" input-channel="productExclusionXSDValidationErrorChannel">
        <int:service-activator ref="productExclusionImportService" method="handleXSDValidationError"></int:service-activator>
    </int:chain>

    <int:chain id="import-product-exclusion-chain" input-channel="productExclusionImportChannel" output-channel="postProductExclusionImportChannel">
        <!-- Convert Document to POJO -->
        <int-xml:unmarshalling-transformer id="defaultUnmarshaller" unmarshaller="productExclusionUnmarshaller"/>
        <!--  Import Product Exclusion -->
        <int:service-activator ref="productExclusionImportService" method="executeImport" />
    </int:chain>

    <int:chain id="post-product-exclusion-import-chain" input-channel="postProductExclusionImportChannel" >
        <int:service-activator ref="productExclusionImportService" method="logImportStatus" />
    </int:chain>


</beans>