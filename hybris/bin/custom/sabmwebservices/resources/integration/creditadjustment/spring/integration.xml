<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/aop
           http://www.springframework.org/schema/aop/spring-aop.xsd
           http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
           http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
		   http://www.springframework.org/schema/integration/file http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
		   http://www.springframework.org/schema/integration/http http://www.springframework.org/schema/integration/http/spring-integration-http.xsd
		   http://www.springframework.org/schema/integration/xml
    	   http://www.springframework.org/schema/integration/xml/spring-integration-xml.xsd
    	   http://www.springframework.org/schema/oxm http://www.springframework.org/schema/oxm/spring-oxm.xsd
    	   http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-file="http://www.springframework.org/schema/integration/file"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xmlns:int-xml="http://www.springframework.org/schema/integration/xml"
       xmlns:int-mail="http://www.springframework.org/schema/integration/mail"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:oxm="http://www.springframework.org/schema/oxm"
       xmlns:task="http://www.springframework.org/schema/task">


    <!-- map the incoming webservice request to a channel -->
    <int-http:inbound-gateway id="inboundCreditAdjustmentRequestGateway"
                              supported-methods="POST"
                              path="/services/creditadjustment"
                              request-channel="preCreditAdjustmentImportChannel"
                              request-payload-type="java.lang.String"
                              reply-timeout="50000">

        <!-- <int-http:request-mapping consumes="application/xml"/> -->
    </int-http:inbound-gateway>

    <!--  credit adjustment Channels -->

    <int:channel id="preCreditAdjustmentImportChannel">
        <int:interceptors>
            <int:wire-tap channel="creditAdjustment_requestLoggingChannel" />
        </int:interceptors>
    </int:channel>

    <int:channel id="creditAdjustmentImportChannel" />
    <int:channel id="postCreditAdjustmentImportChannel" />

    <int:channel id="creditAdjustment_requestLoggingChannel">
        <int:dispatcher task-executor="creditAdjustment_executor" />
    </int:channel>


    <util:map id="creditAdjustmentNamespaceMap">
        <entry key="CreditAdjustmentNs" value="urn:gl.sabmiller.com:com:ecc:mastdata" />
    </util:map>


    <task:executor id="creditAdjustment_executor" pool-size="20" />

    <int:chain id="log-creditAdjustment-payload-chain" input-channel="creditAdjustment_requestLoggingChannel" >
        <int:service-activator ref="creditAdjustmentAsyncLogger" method="saveCreditAdjustmentPayload" />
    </int:chain>

    <int:chain id="pre-credit-adjustment-import-chain" input-channel="preCreditAdjustmentImportChannel"
               output-channel="creditAdjustmentImportChannel">

        <!--  Security filter -->
        <int-xml:validating-filter discard-channel="creditAdjustmentXSDValidationErrorChannel"
                                   throw-exception-on-rejection="true"
                                   xml-validator="securityValidationFilter">
        </int-xml:validating-filter>

        <!-- this is require to enrich the header to handle the content-type of type "application/xml" -->
        <int:header-enricher>
            <int:header name="content-type" value="application/xml"></int:header>
        </int:header-enricher>

        <!--  Add payload Id to the header -->
        <!--<int-xml:xpath-header-enricher id="creditAdjustmentAddPayloadId" default-overwrite="true">
            <int-xml:header name="payloadId"
                            overwrite="true"
                            xpath-expression-ref="creditadjustmentns"
                            evaluation-type="STRING_RESULT" />
        </int-xml:xpath-header-enricher>-->

        <!-- no need to save request payload in Hybris -->
        <!--  Save the incoming payload in Hybris -->
        <!--<int:service-activator ref="creditAdjustmentImportService" method="savePayload" />-->

        <!--  Validate XML against schema -->
        <int-xml:validating-filter discard-channel="creditAdjustmentXSDValidationErrorChannel"
                                   id="creditAdjustmentValidationFilter"
                                   schema-location="integration/creditadjustment/schema/credit-adjustment.xsd"
                                   schema-type="xml-schema"
                                   throw-exception-on-rejection="false">
        </int-xml:validating-filter>

    </int:chain>

    <int:chain id="credit-adjustment-validation-error-chain" input-channel="creditAdjustmentXSDValidationErrorChannel">
        <int:service-activator ref="creditAdjustmentImportService" method="handleXSDValidationError"></int:service-activator>
    </int:chain>

    <int:chain id="import-creditAdjustment-chain" input-channel="creditAdjustmentImportChannel"
               output-channel="postCreditAdjustmentImportChannel">

        <!-- Split the creditAdjustment(Process Result) into items creating a new document for each item-->
        <int-xml:xpath-splitter id="creditAdjustmentItemDocumentSplitter" create-documents="true">
            <int-xml:xpath-expression expression="/CreditAdjustmentNs:CreditAdjustment"  namespace-map="creditAdjustmentNamespaceMap"/>
        </int-xml:xpath-splitter>

        <!-- Convert Document to POJO -->
        <int-xml:unmarshalling-transformer id="defaultCreditAdjustmentUnmarshaller"
                                           unmarshaller="creditAdjustmentMarshaller" />

        <!--  Update credit adjustment status -->
        <int:service-activator ref="creditAdjustmentImportService" method="handleRequest"></int:service-activator>

    </int:chain>

    <int:chain id="post-creditAdjustment-import-chain" input-channel="postCreditAdjustmentImportChannel">
        <int:service-activator ref="creditAdjustmentImportService" method="logCreditAdjustmentRequestStatus"></int:service-activator>
    </int:chain>

</beans>